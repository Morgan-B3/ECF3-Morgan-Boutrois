@page "/books/{Id:guid}"

@inject IBookService BookService
@inject ILoanService LoanService
@inject AuthStateProvider AuthState
@inject NavigationManager Navigation

@using BookHub.Shared.DTOs

<PageTitle>Détail du livre - BookHub</PageTitle>

<a href="/books" class="btn btn-secondary mb-3">
    <i class="bi bi-arrow-left"></i> Retour au catalogue
</a>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary"></div>
    </div>
}
else if (book == null)
{
    <div class="alert alert-danger">
        Livre introuvable.
    </div>
}
else
{
    <div class="row">
        <div class="col-md-4">
            <div class="bg-light d-flex align-items-center justify-content-center"
                 style="height: 300px;">
                @if (!string.IsNullOrEmpty(book.CoverImageUrl))
                {
                    <img src="@book.CoverImageUrl"
                         alt="@book.Title"
                         class="img-fluid" />
                }
                else
                {
                    <i class="bi bi-book display-1 text-secondary"></i>
                }
            </div>
        </div>

        <div class="col-md-8">
            <h2>@book.Title</h2>
            <p class="text-muted">@book.Author</p>

            <p>
                <strong>Catégorie :</strong> @book.Category<br />
                <strong>Année :</strong> @book.PublicationYear
            </p>

            <span class="badge @(book.IsAvailable ? "bg-success" : "bg-danger") mb-3">
                @(book.IsAvailable
                    ? $"{book.AvailableCopies} exemplaire(s) disponible(s)"
                    : "Indisponible")
            </span>

            <hr />

            @if (!isAuthenticated)
            {
                <div class="alert alert-info">
                    <a href="/login">Connectez-vous</a> pour réserver ce livre.
                </div>
            }
            else if (!book.IsAvailable)
            {
                <div class="alert alert-warning">
                    Ce livre n’est actuellement pas disponible.
                </div>
            }
            else
            {
                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="alert alert-success">@successMessage</div>
                }
                else if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger">@errorMessage</div>
                }

                <button class="btn btn-primary"
                        disabled="@isSubmitting"
                        @onclick="ReserveBook">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                    }
                    Réserver ce livre
                </button>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private BookDto? book;
    private bool isLoading = true;
    private bool isSubmitting = false;

    private bool isAuthenticated;
    private UserDto? currentUser;

    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
        await LoadBook();
    }

    private async Task LoadUser()
    {
        currentUser = AuthState.CurrentUser;
        isAuthenticated = currentUser != null;
    }

    private async Task LoadBook()
    {
        isLoading = true;
        try
        {
            book = await BookService.GetBookByIdAsync(Id);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading book: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ReserveBook()
    {
        if (currentUser == null || book == null)
            return;

        isSubmitting = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            var loan = await LoanService.CreateLoanAsync(
                new CreateLoanDto(currentUser.Id, book.Id));

            successMessage = "Livre réservé avec succès";
            book = book with
            {
                AvailableCopies = book.AvailableCopies - 1,
                IsAvailable = book.AvailableCopies - 1 > 0
            };
        }
        catch (Exception ex)
        {
            errorMessage = "Impossible de réserver ce livre.";
            Console.WriteLine($"Loan error: {ex.Message}");
        }
        finally
        {
            isSubmitting = false;
        }
    }
}